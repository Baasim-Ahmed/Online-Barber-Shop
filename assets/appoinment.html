<!DOCTYPE html>
<html lang="en">

<head>
    <title>THE TRADITIONAL TRIM || Appointments Form</title>
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i%7cMontserrat:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- Font Awesome -->
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <!-- Style -->
    <link href="css/style.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        .hidden{
            display: none;
        }
        #floating-box {
      position: fixed; /* Keeps the box in the same position while scrolling */
      top: 10px; /* Distance from the top of the viewport */
      right: 10px; /* Distance from the right of the viewport */
      width: 160px;
      height: 70px;
      background-color: rgba(189, 38, 38, 0.664);
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      padding: 10px;
    }
    #creditpoints{
      text-align: center;
    }
    </style>
    
</head>

<body>
    <div id="floating-box" class=" hidden">
        <h4 style="font-size: medium;font-weight: bold;margin-bottom: 0px;">Credit Points:</h4>
        <p id="creditpoints" style="font-size: large;color: black;"></p>
      </div>
      
    <div class="page-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="page-caption">
                        <h2 class="page-title">Book Appointment</h2>
                        <div class="page-breadcrumb">
                            <ol class="breadcrumb">
                                <li><a href="#" id="homeLink">Home</a></li>

                                <li class="active">Book Appointment</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="content">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-12">
                    <div class="row">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                            <h1>Appointment Form</h1>
                            <p> Book your appointment to save salon rush.</p>
                            <form id="appointmentForm">
                                <div class="row">
                                    <!-- <div class="col-md-6">
                                        <label class="control-label" for="name">Name</label>
                                        <input type="text" class="form-control" id="name" placeholder="Name" name="name" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="control-label" for="phone">Phone</label>
                                        <input type="text" class="form-control" id="phone" name="phone" placeholder="Phone" required maxlength="10" pattern="[0-9]+">
                                    </div>
                                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                        <label class="control-label" for="email">Email</label>
                                         <input type="email" class="form-control" id="email" placeholder="Email" name="email" required>
                                    </div> -->
                                    <input id="customerID" type="number" hidden/>
                                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                        <div class="form-group">
                                            <label class="control-label" for="services" style="font-size: 18px;">Available Services</label>
                                            <div id="services" class="checkbox-container">
                                                
                                                <!-- Checkboxes will be populated dynamically here -->
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                        <div class="form-group">
                                            <label class="control-label" for="">Select Barber</label>
                                            <select class="form-control" name="employee" id="employee" onchange="fetchTimeslots()">
                                                <option value="0">Please select</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                        <div class="form-group">
                                            <label class="control-label" for="adate">Appointment Date</label>
                                            <input type="date" class="form-control" name="adate" id="inputdate" onchange="fetchTimeslots()">
                                        </div>
                                    </div>
                                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                        <div class="form-group">
                                            <label class="control-label" for="atime">Appointment Time</label>
                                            <select class="form-control" name="atime" id="atime" >
                                                <option value="0">Please select</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="creditID" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 hidden">
                                        <div class="form-group">
                                            <label class="control-label" for="creditPointsDropdown">Credit Points</label>
                                            <select id="creditPointsDropdown" class="form-control">
                                                <option value="0">Please select</option>
                                                <!-- Options will be dynamically populated here -->
                                            </select>
                                        </div>
                                    </div>
                                    
                                    
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <button type="submit" id="submit" class="btn btn-default">Book</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div id="responseMessage"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="js/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    <script src="js/menumaker.js"></script>
    <script src="js/jquery.sticky.js"></script>
    <script src="js/sticky-header.js"></script>
    <script type="text/javascript">


        $(function() {
        var dtToday = new Date();
    
        var month = dtToday.getMonth() + 1;
        var day = dtToday.getDate();
        var year = dtToday.getFullYear();
        if(month < 10)
            month = '0' + month.toString();
        if(day < 10)
            day = '0' + day.toString();
        var maxDate = year + '-' + month + '-' + day;
        $('#inputdate').attr('min', maxDate);
    });
    

document.getElementById('appointmentForm').addEventListener('submit', async function (event) {
    event.preventDefault();

    const selectedServices = [];
    const checkboxes = document.querySelectorAll('#services input[name="selectedServices"]:checked');
    checkboxes.forEach((checkbox) => {
        selectedServices.push(checkbox.value);
    });

    const adate = document.getElementById('inputdate').value;
    const atime = document.getElementById('atime').value;
    const employeeid = document.getElementById('employee').value;
    const customerID = document.getElementById('customerID').value;
    const Remarks = '';
    const creditpoints = parseInt(document.getElementById('creditPointsDropdown').value, 10) || 0;

    try {
        // Fetch service data once
        const serviceUrl = new URL('http://localhost:3000/api/fetchServiceNames');
        serviceUrl.searchParams.append('status', 1); // Append query params correctly to the URL

        const serviceResponse = await fetch(serviceUrl);
        const serviceData = await serviceResponse.json();

        // Calculate total price of selected services
        let totalPrice = 0;
        let totalCredit = 0;
        let serviceDetails = null;
        selectedServices.forEach((service) => {
        const serviceId = parseInt(service, 10); // Convert the service value to an integer
        const serviceDetails = serviceData.find((item) => item.ID === serviceId); // Use the converted integer for comparison
        if (serviceDetails) {
            
            totalPrice += parseInt(serviceDetails.Cost,10);
            totalCredit += parseInt(serviceDetails.ServiceCredit,10);
        } else {
            console.warn('Service not found for ID:', serviceId);
        }
        });


        console.log('Total Price before discount:', totalPrice);  // Debugging log

        // Apply discount based on credit points
        let discounted = 0;
        if (creditpoints === 100) {
            discounted = totalPrice * 0.1;
            totalPrice -= discounted;
        } else if (creditpoints === 200) {
            discounted = totalPrice * 0.2;
            totalPrice -= discounted;
        } else if (creditpoints === 300) {
            discounted = totalPrice * 0.3;
            totalPrice -= discounted;
        } else if (creditpoints === 400) {
            discounted = totalPrice * 0.4;
            totalPrice -= discounted;
        } else if (creditpoints === 500) {
            discounted = totalPrice * 0.5;
            totalPrice -= discounted;
        } else if (creditpoints === 600) {
            discounted = totalPrice * 0.6;
            totalPrice -= discounted;
        }
        

        console.log('Total Price after discount:', totalPrice);  // Debugging log

        // Fetch current customer credit points
        const responseCredit = await fetch(`http://localhost:3000/api/creditpoints/${customerID}`);
        const creditData = await responseCredit.json();
        let currentCreditPoints = parseInt(creditData.CreditPoints, 10);
        totalCredit = parseInt(totalCredit,10);

        // Update customer credit points
        if (creditpoints === 0) {
            currentCreditPoints += totalCredit; // Add earned points
        } else {
            currentCreditPoints -= creditpoints; // Deduct used points
        }

        // Update the customer's credit points in the database
        await fetch(`http://localhost:3000/api/updateCustomerCredits/${customerID}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ CreditPoints: currentCreditPoints }),
        });

        // Create the appointment
        const appointmentResponse = await fetch('http://localhost:3000/api/AddAppointments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                employeeid,
                customerID,
                adate,
                atime,
                Remarks,
                totalPrice,
                selectedServices,
            }),
        });

        const result = await appointmentResponse.json();
        

        const responseMessage = document.getElementById('responseMessage');
        if (appointmentResponse.ok) {
            responseMessage.innerHTML = `<p>Appointment booked successfully. Your appointment number is ${result.appointmentID}</p><p>Total Price: $${totalPrice.toFixed(2)}</p>`;
            setTimeout(() => {
                window.location.href = `thankyou.html?aptno=${result.appointmentID}&customerID=${result.customerID}`;
            }, 10);
        } else {
            responseMessage.innerHTML = `<p>Something went wrong. Please try again.</p>`;
        }
    } catch (error) {
        console.error('Error:', error);
        const responseMessage = document.getElementById('responseMessage');
        responseMessage.innerHTML = `<p>Something went wrong. Please try again.</p>`;
    }
});

        function getQueryParams() {
                const params = {};
                const queryString = window.location.search.substring(1);
                const pairs = queryString.split("&");
                for (const pair of pairs) {
                    const [key, value] = pair.split("=");
                    params[key] = decodeURIComponent(value);
                }
                return params;
            }
    
            document.addEventListener('DOMContentLoaded', function() {
          
          // Get customerID from query parameters
          const params = getQueryParams();
          const customerID = params.customerID;
    
          // Display the customerID on the page
          if (customerID) {
              document.getElementById("customerID").value = customerID;
              const homeLink = document.getElementById('homeLink');
              homeLink.href = `home.html?customerID=${customerID}`;
          }
      });
        
            function fetchTimeslots() {
                const employeeid = document.getElementById('employee').value;
                const appointmentdate = document.getElementById('inputdate').value;
                const timeslotsSelect = document.getElementById('atime');
                if(employeeid==null || employeeid==0 || appointmentdate == "" || appointmentdate==null) {
                    timeslotsSelect.innerHTML = '<option value="0">Select Time Slot</option>';
                    return false;
                }
    
                fetch(`http://localhost:3000/api/fetchtimeslots?AptDate=${appointmentdate}&EmployeeID=${employeeid}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(timeslots => {
                        
                        
                        timeslotsSelect.innerHTML = '<option value="0">Select Time Slot</option>';
                        timeslots.forEach(timeslot => {
                            const option = document.createElement('option');
                            option.value = timeslot.ID;
                            option.textContent = timeslot.TimeSlots;
                            timeslotsSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        alert("Function ERROR: " + error);
                        console.error('Error fetching timeslots:', error);
                    });
            }

        async function fetchServicesNames() {
            try {
                const url = new URL('http://localhost:3000/api/fetchServiceNames');
                url.searchParams.append('status', 1);
    
                const response = await fetch(url);
    
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
    
                const services = await response.json();
    
                const servicesContainer = document.getElementById('services');
                servicesContainer.innerHTML = ''; // Clear existing checkboxes
    
                services.forEach(service => {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'selectedServices';
                    checkbox.value = service.ID;
                    checkbox.style.marginLeft = '50px';
                    
                    const label = document.createElement('label');
                    label.textContent = service.ServiceName;
                    label.style.marginLeft = '10px';
                    const br = document.createElement('br');
    
                    servicesContainer.appendChild(checkbox);
                    servicesContainer.appendChild(label);
                    servicesContainer.appendChild(br);
                });
            } catch (error) {
                alert("Function ERROR: " + error);
                console.error('Error fetching services:', error);
            }
        }
    
        function fetchEmployee() {
                fetch('http://localhost:3000/api/barbers')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(rows => {
                        const dropdown = document.getElementById('employee');
                        rows.forEach(row => {
                            const option = document.createElement('option');
                            option.value = row.ID;
                            option.textContent = row.EmpName;
                            dropdown.appendChild(option);
                        });
                    })
                    .catch(error => {
                        alert("Function ERROR: " + error);
                        console.error('Error fetching timeslots:', error);
                    });
            }
            // Call fetchTimeslots when the page loads
async function fetchCreditPoints(customeID) {
    try {
        const response = await fetch(`http://localhost:3000/api/creditpoints/${customeID}`);
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        const CreditElement = document.getElementById('creditpoints');
        const creditPointsDropdown = document.getElementById('creditPointsDropdown');
        
        let creditPoints = data.CreditPoints || 0;
        CreditElement.textContent = creditPoints; // Update the text content with the count

        // Show the dropdown if credit points are greater than or equal to 50
        if (creditPoints >= 100) {
    // Clear existing options and reset to the "Please select" option
    creditPointsDropdown.innerHTML = ''; 

    // Add the "Please select" option back as the default
    const defaultOption = document.createElement('option');
    defaultOption.value = '0';  // Keeping value as '0' for "Please select"
    defaultOption.textContent = 'Please select';
    defaultOption.disabled = true; // Make it non-selectable
    defaultOption.selected = true; // Make it selected by default
    creditPointsDropdown.appendChild(defaultOption);

    // Populate dropdown options based on available credit points
        const maxPoints = Math.min(600, creditPoints);
        for (let i = 100; i <= maxPoints; i += 100) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            creditPointsDropdown.appendChild(option);
        }

        // Show the floating box and the credit ID section
        document.getElementById('floating-box').classList.remove('hidden');
        document.getElementById('creditID').classList.remove('hidden');
    }

    } catch (error) {
        console.error('Error fetching credit points:', error);
    }
}
    
            $(document).ready(function() {
                const params = getQueryParams();
                fetchServicesNames();
                fetchEmployee();
                fetchCreditPoints(params.customerID);

            });
        </script>
    
</body>

</html>






